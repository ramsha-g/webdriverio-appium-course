"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SyslogDecoder = void 0;
exports.toUtf8String = toUtf8String;
require("source-map-support/register");
var _stream = _interopRequireDefault(require("stream"));
const NEW_LINE_CODE = 0x0A;
const NULL_DELIMETER_CODE = 0x00;
const BACKSLASH_CODE = '\\'.codePointAt(0);
const M_CODE = 'M'.charCodeAt(0);
const DASH_CODE = '-'.charCodeAt(0);
const DASH_SHIFT = 0x80;
const ARROW_CODE = '^'.charCodeAt(0);
const ARROW_SHIFT = 0x40;
const ESCAPE_TOKEN_LEN = 4;
function toUtf8String(logBuffer) {
  const parseUtf8Bytes = start => {
    let cursor = start;
    const token = new Uint8Array(ESCAPE_TOKEN_LEN);
    const utf8CharsAsBytes = [];
    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {
      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);
      if (token[0] !== BACKSLASH_CODE && token[1] !== M_CODE && ![DASH_CODE, ARROW_CODE].includes(token[2])) {
        return [cursor, utf8CharsAsBytes];
      }
      const nextByte = token[3] + (token[2] === DASH_CODE ? DASH_SHIFT : ARROW_SHIFT);
      utf8CharsAsBytes.push(nextByte);
      cursor += ESCAPE_TOKEN_LEN;
    }
    return [cursor, utf8CharsAsBytes];
  };
  let index = 0;
  const bytesView = new Uint8Array(logBuffer);
  const utf8Codes = [];
  while (index < bytesView.length) {
    if (bytesView[index] === BACKSLASH_CODE) {
      const [newIndex, bytes] = parseUtf8Bytes(index);
      if (newIndex > index) {
        utf8Codes.push(...bytes);
        index = newIndex;
        continue;
      }
    }
    utf8Codes.push(bytesView[index++]);
  }
  return Buffer.from(utf8Codes).toString('utf8');
}
class SyslogDecoder extends _stream.default.Transform {
  constructor(bufferLength) {
    super({
      objectMode: true
    });
    this.bufferIndex = 0;
    this.buffer = Buffer.allocUnsafe(bufferLength);
  }
  _transform(data, encoding, onData) {
    this._decode(data);
    onData();
  }
  _decode(data) {
    for (let i = 0; i < data.length; i++) {
      if (data[i] === NULL_DELIMETER_CODE) {
        continue;
      }
      if (data[i] === NEW_LINE_CODE) {
        if (this.bufferIndex > 0) {
          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);
          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);
          this.push(toUtf8String(stringBuffer), 'utf8');
          this.bufferIndex = 0;
        }
        continue;
      }
      this.buffer[this.bufferIndex] = data[i];
      this.bufferIndex++;
    }
  }
}
exports.SyslogDecoder = SyslogDecoder;
var _default = SyslogDecoder;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3RyZWFtIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJORVdfTElORV9DT0RFIiwiTlVMTF9ERUxJTUVURVJfQ09ERSIsIkJBQ0tTTEFTSF9DT0RFIiwiY29kZVBvaW50QXQiLCJNX0NPREUiLCJjaGFyQ29kZUF0IiwiREFTSF9DT0RFIiwiREFTSF9TSElGVCIsIkFSUk9XX0NPREUiLCJBUlJPV19TSElGVCIsIkVTQ0FQRV9UT0tFTl9MRU4iLCJ0b1V0ZjhTdHJpbmciLCJsb2dCdWZmZXIiLCJwYXJzZVV0ZjhCeXRlcyIsInN0YXJ0IiwiY3Vyc29yIiwidG9rZW4iLCJVaW50OEFycmF5IiwidXRmOENoYXJzQXNCeXRlcyIsImxlbmd0aCIsImNvcHkiLCJpbmNsdWRlcyIsIm5leHRCeXRlIiwicHVzaCIsImluZGV4IiwiYnl0ZXNWaWV3IiwidXRmOENvZGVzIiwibmV3SW5kZXgiLCJieXRlcyIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsIlN5c2xvZ0RlY29kZXIiLCJTdHJlYW0iLCJUcmFuc2Zvcm0iLCJjb25zdHJ1Y3RvciIsImJ1ZmZlckxlbmd0aCIsIm9iamVjdE1vZGUiLCJidWZmZXJJbmRleCIsImJ1ZmZlciIsImFsbG9jVW5zYWZlIiwiX3RyYW5zZm9ybSIsImRhdGEiLCJlbmNvZGluZyIsIm9uRGF0YSIsIl9kZWNvZGUiLCJpIiwic3RyaW5nQnVmZmVyIiwiZXhwb3J0cyIsIl9kZWZhdWx0IiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9zeXNsb2cvdHJhbnNmb3JtZXIvc3lzbG9nLWRlY29kZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0cmVhbSBmcm9tICdzdHJlYW0nO1xuXG5jb25zdCBORVdfTElORV9DT0RFID0gMHgwQTtcbmNvbnN0IE5VTExfREVMSU1FVEVSX0NPREUgPSAweDAwO1xuY29uc3QgQkFDS1NMQVNIX0NPREUgPSAnXFxcXCcuY29kZVBvaW50QXQoMCk7XG5jb25zdCBNX0NPREUgPSAnTScuY2hhckNvZGVBdCgwKTtcbmNvbnN0IERBU0hfQ09ERSA9ICctJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgREFTSF9TSElGVCA9IDB4ODA7XG5jb25zdCBBUlJPV19DT0RFID0gJ14nLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBBUlJPV19TSElGVCA9IDB4NDA7XG5jb25zdCBFU0NBUEVfVE9LRU5fTEVOID0gNDtcblxuXG4vKipcbiAqIFVuZXNjYXBlcyB1dGY4LWVuY29kZWQgY2hhcmFjdGVycywgc28gdGhlIG91dHB1dCBsb29rc1xuICogbGlrZSBhIHZhbGlkIHN0cmluZy4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xNDQ3NlxuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge0J1ZmZlcn0gbG9nQnVmZmVyIEEgc2luZ2xlIGVzY2FwZWQgbG9nIGxpbmVcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSB1bmVzY2FwZWQgc3RyaW5nIG9yIHRoZSBzYW1lIHN0cmluZyBpZiBubyB1bmVzY2FwaW5nXG4gKiBpcyBuZWNlc3NhcnkuXG4gKi9cbmZ1bmN0aW9uIHRvVXRmOFN0cmluZyhsb2dCdWZmZXIpIHtcbiAgY29uc3QgcGFyc2VVdGY4Qnl0ZXMgPSAoc3RhcnQpID0+IHtcbiAgICBsZXQgY3Vyc29yID0gc3RhcnQ7XG4gICAgY29uc3QgdG9rZW4gPSBuZXcgVWludDhBcnJheShFU0NBUEVfVE9LRU5fTEVOKTtcbiAgICBjb25zdCB1dGY4Q2hhcnNBc0J5dGVzID0gW107XG4gICAgd2hpbGUgKGN1cnNvciA8PSBsb2dCdWZmZXIubGVuZ3RoIC0gRVNDQVBFX1RPS0VOX0xFTikge1xuICAgICAgbG9nQnVmZmVyLmNvcHkodG9rZW4sIDAsIGN1cnNvciwgY3Vyc29yICsgRVNDQVBFX1RPS0VOX0xFTik7XG4gICAgICBpZiAodG9rZW5bMF0gIT09IEJBQ0tTTEFTSF9DT0RFICYmIHRva2VuWzFdICE9PSBNX0NPREUgJiYgIVtEQVNIX0NPREUsIEFSUk9XX0NPREVdLmluY2x1ZGVzKHRva2VuWzJdKSkge1xuICAgICAgICByZXR1cm4gW2N1cnNvciwgdXRmOENoYXJzQXNCeXRlc107XG4gICAgICB9XG4gICAgICBjb25zdCBuZXh0Qnl0ZSA9IHRva2VuWzNdICsgKHRva2VuWzJdID09PSBEQVNIX0NPREUgPyBEQVNIX1NISUZUIDogQVJST1dfU0hJRlQpO1xuICAgICAgdXRmOENoYXJzQXNCeXRlcy5wdXNoKG5leHRCeXRlKTtcbiAgICAgIGN1cnNvciArPSBFU0NBUEVfVE9LRU5fTEVOO1xuICAgIH1cbiAgICByZXR1cm4gW2N1cnNvciwgdXRmOENoYXJzQXNCeXRlc107XG4gIH07XG5cbiAgbGV0IGluZGV4ID0gMDtcbiAgY29uc3QgYnl0ZXNWaWV3ID0gbmV3IFVpbnQ4QXJyYXkobG9nQnVmZmVyKTtcbiAgY29uc3QgdXRmOENvZGVzID0gW107XG4gIHdoaWxlIChpbmRleCA8IGJ5dGVzVmlldy5sZW5ndGgpIHtcbiAgICBpZiAoYnl0ZXNWaWV3W2luZGV4XSA9PT0gQkFDS1NMQVNIX0NPREUpIHtcbiAgICAgIGNvbnN0IFtuZXdJbmRleCwgYnl0ZXNdID0gcGFyc2VVdGY4Qnl0ZXMoaW5kZXgpO1xuICAgICAgaWYgKG5ld0luZGV4ID4gaW5kZXgpIHtcbiAgICAgICAgdXRmOENvZGVzLnB1c2goLi4uYnl0ZXMpO1xuICAgICAgICBpbmRleCA9IG5ld0luZGV4O1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgdXRmOENvZGVzLnB1c2goYnl0ZXNWaWV3W2luZGV4KytdKTtcbiAgfVxuICByZXR1cm4gQnVmZmVyLmZyb20odXRmOENvZGVzKS50b1N0cmluZygndXRmOCcpO1xufVxuXG5cbmNsYXNzIFN5c2xvZ0RlY29kZXIgZXh0ZW5kcyBTdHJlYW0uVHJhbnNmb3JtIHtcblxuICBjb25zdHJ1Y3RvciAoYnVmZmVyTGVuZ3RoKSB7XG4gICAgc3VwZXIoeyBvYmplY3RNb2RlOiB0cnVlIH0pO1xuICAgIHRoaXMuYnVmZmVySW5kZXggPSAwO1xuICAgIHRoaXMuYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKGJ1ZmZlckxlbmd0aCk7XG4gIH1cblxuICBfdHJhbnNmb3JtIChkYXRhLCBlbmNvZGluZywgb25EYXRhKSB7XG4gICAgdGhpcy5fZGVjb2RlKGRhdGEpO1xuICAgIG9uRGF0YSgpO1xuICB9XG5cbiAgX2RlY29kZSAoZGF0YSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgLy8gRG9uJ3Qgc3RvcmUgdGhlIG51bGwgZGVsaW1ldGVyIG1lc3NhZ2VzXG4gICAgICBpZiAoZGF0YVtpXSA9PT0gTlVMTF9ERUxJTUVURVJfQ09ERSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIFB1c2ggdGhlIGRhdGEgd2hlbiBuZXcgbGluZSBpcyBzZW50XG4gICAgICBpZiAoZGF0YVtpXSA9PT0gTkVXX0xJTkVfQ09ERSkge1xuICAgICAgICBpZiAodGhpcy5idWZmZXJJbmRleCA+IDApIHtcbiAgICAgICAgICBjb25zdCBzdHJpbmdCdWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUodGhpcy5idWZmZXJJbmRleCk7XG4gICAgICAgICAgdGhpcy5idWZmZXIuY29weShzdHJpbmdCdWZmZXIsIDAsIDAsIHRoaXMuYnVmZmVySW5kZXgpO1xuICAgICAgICAgIHRoaXMucHVzaCh0b1V0ZjhTdHJpbmcoc3RyaW5nQnVmZmVyKSwgJ3V0ZjgnKTtcbiAgICAgICAgICB0aGlzLmJ1ZmZlckluZGV4ID0gMDtcbiAgICAgICAgfVxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYnVmZmVyW3RoaXMuYnVmZmVySW5kZXhdID0gZGF0YVtpXTtcbiAgICAgIHRoaXMuYnVmZmVySW5kZXgrKztcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgU3lzbG9nRGVjb2RlciwgdG9VdGY4U3RyaW5nIH07XG5leHBvcnQgZGVmYXVs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