{"version":3,"file":"syslog-decoder.js","names":["_stream","_interopRequireDefault","require","NEW_LINE_CODE","NULL_DELIMETER_CODE","BACKSLASH_CODE","codePointAt","M_CODE","charCodeAt","DASH_CODE","DASH_SHIFT","ARROW_CODE","ARROW_SHIFT","ESCAPE_TOKEN_LEN","toUtf8String","logBuffer","parseUtf8Bytes","start","cursor","token","Uint8Array","utf8CharsAsBytes","length","copy","includes","nextByte","push","index","bytesView","utf8Codes","newIndex","bytes","Buffer","from","toString","SyslogDecoder","Stream","Transform","constructor","bufferLength","objectMode","bufferIndex","buffer","allocUnsafe","_transform","data","encoding","onData","_decode","i","stringBuffer","exports","_default","default"],"sources":["../../../../lib/syslog/transformer/syslog-decoder.js"],"sourcesContent":["import Stream from 'stream';\n\nconst NEW_LINE_CODE = 0x0A;\nconst NULL_DELIMETER_CODE = 0x00;\nconst BACKSLASH_CODE = '\\\\'.codePointAt(0);\nconst M_CODE = 'M'.charCodeAt(0);\nconst DASH_CODE = '-'.charCodeAt(0);\nconst DASH_SHIFT = 0x80;\nconst ARROW_CODE = '^'.charCodeAt(0);\nconst ARROW_SHIFT = 0x40;\nconst ESCAPE_TOKEN_LEN = 4;\n\n\n/**\n * Unescapes utf8-encoded characters, so the output looks\n * like a valid string. See https://github.com/appium/appium/issues/14476\n * for more details.\n *\n * @param {Buffer} logBuffer A single escaped log line\n * @returns {string} The unescaped string or the same string if no unescaping\n * is necessary.\n */\nfunction toUtf8String(logBuffer) {\n  const parseUtf8Bytes = (start) => {\n    let cursor = start;\n    const token = new Uint8Array(ESCAPE_TOKEN_LEN);\n    const utf8CharsAsBytes = [];\n    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {\n      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);\n      if (token[0] !== BACKSLASH_CODE && token[1] !== M_CODE && ![DASH_CODE, ARROW_CODE].includes(token[2])) {\n        return [cursor, utf8CharsAsBytes];\n      }\n      const nextByte = token[3] + (token[2] === DASH_CODE ? DASH_SHIFT : ARROW_SHIFT);\n      utf8CharsAsBytes.push(nextByte);\n      cursor += ESCAPE_TOKEN_LEN;\n    }\n    return [cursor, utf8CharsAsBytes];\n  };\n\n  let index = 0;\n  const bytesView = new Uint8Array(logBuffer);\n  const utf8Codes = [];\n  while (index < bytesView.length) {\n    if (bytesView[index] === BACKSLASH_CODE) {\n      const [newIndex, bytes] = parseUtf8Bytes(index);\n      if (newIndex > index) {\n        utf8Codes.push(...bytes);\n        index = newIndex;\n        continue;\n      }\n    }\n    utf8Codes.push(bytesView[index++]);\n  }\n  return Buffer.from(utf8Codes).toString('utf8');\n}\n\n\nclass SyslogDecoder extends Stream.Transform {\n\n  constructor (bufferLength) {\n    super({ objectMode: true });\n    this.bufferIndex = 0;\n    this.buffer = Buffer.allocUnsafe(bufferLength);\n  }\n\n  _transform (data, encoding, onData) {\n    this._decode(data);\n    onData();\n  }\n\n  _decode (data) {\n    for (let i = 0; i < data.length; i++) {\n      // Don't store the null delimeter messages\n      if (data[i] === NULL_DELIMETER_CODE) {\n        continue;\n      }\n      // Push the data when new line is sent\n      if (data[i] === NEW_LINE_CODE) {\n        if (this.bufferIndex > 0) {\n          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);\n          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);\n          this.push(toUtf8String(stringBuffer), 'utf8');\n          this.bufferIndex = 0;\n        }\n        continue;\n      }\n      this.buffer[this.bufferIndex] = data[i];\n      this.bufferIndex++;\n    }\n  }\n}\n\nexport { SyslogDecoder, toUtf8String };\nexport default SyslogDecoder;\n"],"mappings":"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"}