"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _support = require("@appium/support");
var _teen_process = require("teen_process");
var _lodash = _interopRequireDefault(require("lodash"));
var _asyncbox = require("asyncbox");
var _helpers = require("../helpers");
var _logger = _interopRequireDefault(require("../logger.js"));
const COMPANION_PGREP_PATTERN = udid => `${_helpers.IDB_COMPANION_EXECUTABLE}.*--udid[[:space:]]+${udid}`;
const systemCallMethods = {};
systemCallMethods.connect = async function connect(opts = {}) {
  const {
    onlineTimeout
  } = opts;
  const binaryPaths = {};
  for (const binary of [_helpers.IDB_EXECUTABLE, _helpers.IDB_COMPANION_EXECUTABLE]) {
    try {
      binaryPaths[binary] = await _support.fs.which(binary);
    } catch (e) {
      throw new Error(`'${binary}' has not been found in PATH. ` + `Is it installed? Read https://www.fbidb.io for more details`);
    }
  }
  _logger.default.debug(`Starting and connecting companion: '${binaryPaths[_helpers.IDB_COMPANION_EXECUTABLE]}'`);
  try {
    try {
      await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['connect', this.udid]);
    } catch (connectionError) {
      await (0, _asyncbox.retryInterval)(2, 100, async () => {
        await this.disconnect();
        try {
          await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['kill']);
        } catch (ign) {}
        await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['connect', this.udid]);
      });
    }
  } catch (e) {
    if (e.stderr || e.stdout) {
      _logger.default.debug(e.stderr || e.stdout);
    }
    throw new Error(`Cannot start ${_helpers.IDB_EXECUTABLE} service for the device '${this.udid}'. ` + `Check the server log for more details.`);
  }
  _logger.default.info(`Successfully established the connection to ${_helpers.IDB_EXECUTABLE} service for '${this.udid}'`);
  if (onlineTimeout) {
    await this.waitForDevice(onlineTimeout);
  }
  this.executable.path = binaryPaths[_helpers.IDB_EXECUTABLE];
  this.companion.path = binaryPaths[_helpers.IDB_COMPANION_EXECUTABLE];
};
systemCallMethods.waitForDevice = async function waitForDevice(timeoutMs = 10000) {
  if (!timeoutMs) {
    _logger.default.debug('No timeout is provided, so not waiting until the device is online');
    return;
  }
  _logger.default.debug(`Waiting up to ${timeoutMs}ms for the device to be online`);
  const timer = new _support.timing.Timer().start();
  let lastError = null;
  try {
    await (0, _asyncbox.waitForCondition)(async () => {
      try {
        await this.exec(['ui', 'describe-all']);
        return true;
      } catch (e) {
        lastError = e.stderr || e.message;
        return false;
      }
    }, {
      waitMs: timeoutMs,
      intervalMs: 300
    });
  } catch (e) {
    throw new Error(`The device '${this.udid}' is not responding to idb requests after ${timeoutMs}ms timeout. ` + `Original error: ${lastError || e.message}`);
  }
  _logger.default.debug(`The device '${this.udid}' is online and ready to accept idb commands in ` + `${timer.getDuration().asSeconds.toFixed(3)}s`);
};
systemCallMethods.disconnect = async function disconnect() {
  _logger.default.debug(`Disconnecting ${_helpers.IDB_EXECUTABLE} service from '${this.udid}'`);
  try {
    await (0, _teen_process.exec)(this.executable.path, ['disconnect', this.udid]);
  } catch (ign) {}
  const companionPids = await (0, _helpers.getPids)(COMPANION_PGREP_PATTERN(this.udid));
  if (_lodash.default.isEmpty(companionPids)) {
    return;
  }
  _logger.default.debug(`Cleaning up ${companionPids.length} obsolete ${_helpers.IDB_COMPANION_EXECUTABLE} ` + `process${companionPids.length === 1 ? '' : 'es'}`);
  await (0, _teen_process.exec)('kill', ['-2', ...companionPids]);
};
systemCallMethods.exec = async function exec(cmd, args = [], opts = {}) {
  if (!cmd) {
    throw new Error('You need to pass in a command to exec()');
  }
  cmd = _lodash.default.isArray(cmd) ? cmd : [cmd];
  opts = _lodash.default.cloneDeep(opts);
  opts.timeout = opts.timeout || this.execTimeout || _helpers.DEFAULT_IDB_EXEC_TIMEOUT;
  opts.timeoutCapName = opts.timeoutCapName || 'execTimeout';
  const fullArgs = [...cmd, ...this.executable.defaultArgs, ...args];
  _logger.default.debug(`Running '${this.executable.path} ${_support.util.quote(fullArgs)}'`);
  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(this.executable.path, fullArgs, opts);
    return stdout;
  } catch (e) {
    if (_support.util.hasValue(e.code)) {
      e.message = `Error executing ${_helpers.IDB_EXECUTABLE}. Original error: '${e.message}'; ` + `Stdout: '${(e.stdout || '').trim()}'; ` + `Stderr: '${(e.stderr || '').trim()}'; ` + `Code: '${e.code}'`;
    } else {
      e.message = `Error executing ${_helpers.IDB_EXECUTABLE}. Original error: '${e.message}'. ` + `Try to increase the ${opts.timeout}ms ${_helpers.IDB_EXECUTABLE} execution timeout represented by '${opts.timeoutCapName}' capability`;
    }
    throw e;
  }
};
systemCallMethods.createSubProcess = function createSubProcess(command = [], args = [], opts = {}) {
  const idbArgs = [...command, ...this.executable.defaultArgs, ...args];
  _logger.default.debug(`Creating ${_helpers.IDB_EXECUTABLE} subprocess with args: ${_support.util.quote(args)}`);
  return new _teen_process.SubProcess(this.executable.path, idbArgs, opts);
};
var _default = systemCallMethods;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3VwcG9ydCIsInJlcXVpcmUiLCJfdGVlbl9wcm9jZXNzIiwiX2xvZGFzaCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJfYXN5bmNib3giLCJfaGVscGVycyIsIl9sb2dnZXIiLCJDT01QQU5JT05fUEdSRVBfUEFUVEVSTiIsInVkaWQiLCJJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEUiLCJzeXN0ZW1DYWxsTWV0aG9kcyIsImNvbm5lY3QiLCJvcHRzIiwib25saW5lVGltZW91dCIsImJpbmFyeVBhdGhzIiwiYmluYXJ5IiwiSURCX0VYRUNVVEFCTEUiLCJmcyIsIndoaWNoIiwiZSIsIkVycm9yIiwibG9nIiwiZGVidWciLCJ0cEV4ZWMiLCJjb25uZWN0aW9uRXJyb3IiLCJyZXRyeUludGVydmFsIiwiZGlzY29ubmVjdCIsImlnbiIsInN0ZGVyciIsInN0ZG91dCIsImluZm8iLCJ3YWl0Rm9yRGV2aWNlIiwiZXhlY3V0YWJsZSIsInBhdGgiLCJjb21wYW5pb24iLCJ0aW1lb3V0TXMiLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJsYXN0RXJyb3IiLCJ3YWl0Rm9yQ29uZGl0aW9uIiwiZXhlYyIsIm1lc3NhZ2UiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiZ2V0RHVyYXRpb24iLCJhc1NlY29uZHMiLCJ0b0ZpeGVkIiwiY29tcGFuaW9uUGlkcyIsImdldFBpZHMiLCJfIiwiaXNFbXB0eSIsImxlbmd0aCIsImNtZCIsImFyZ3MiLCJpc0FycmF5IiwiY2xvbmVEZWVwIiwidGltZW91dCIsImV4ZWNUaW1lb3V0IiwiREVGQVVMVF9JREJfRVhFQ19USU1FT1VUIiwidGltZW91dENhcE5hbWUiLCJmdWxsQXJncyIsImRlZmF1bHRBcmdzIiwidXRpbCIsInF1b3RlIiwiaGFzVmFsdWUiLCJjb2RlIiwidHJpbSIsImNyZWF0ZVN1YlByb2Nlc3MiLCJjb21tYW5kIiwiaWRiQXJncyIsIlN1YlByb2Nlc3MiLCJfZGVmYXVsdCIsImV4cG9ydHMiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL3Rvb2xzL3N5c3RlbS1jb21tYW5kcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdXRpbCwgdGltaW5nIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgYXMgdHBFeGVjLCBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsLCB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHtcbiAgZ2V0UGlkcywgREVGQVVMVF9JREJfRVhFQ19USU1FT1VULCBJREJfRVhFQ1VUQUJMRSxcbiAgSURCX0NPTVBBTklPTl9FWEVDVVRBQkxFLFxufSBmcm9tICcuLi9oZWxwZXJzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcblxuXG5jb25zdCBDT01QQU5JT05fUEdSRVBfUEFUVEVSTiA9ICh1ZGlkKSA9PlxuICBgJHtJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEV9LiotLXVkaWRbWzpzcGFjZTpdXSske3VkaWR9YDtcblxuY29uc3Qgc3lzdGVtQ2FsbE1ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDb25uZWN0T3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gb25saW5lVGltZW91dCAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXRcbiAqIHVudGlsIHRoZSBkZXZpY2UgdW5kZXIgdGVzdHMgaXMgb25saW5lLiBObyB3YWl0IGlzIGdvaW5nIHRvIGJlIHBlcmZvcm1lZFxuICogaWYgdGhlIHRpbWVvdXQgaXMgbm90IHNldC4gSXQgaXMgcmVjb21tZW5kZWQgdG8gcHJvdmlkZSB0aGlzIHZhbHVlIGlmXG4gKiBgY29ubmVjdGAgaXMgY2FsbGVkIHJpZ2h0IGFmdGVyIGRldmljZSBpcyBib290ZWQsIHNvIG5vdCBhbGwgdGhlIHJlcXVpcmVkXG4gKiBkZXZpY2Ugc2VydmljZXMgaGF2ZSBiZWVuIHN0YXJ0ZWQgeWV0LlxuICovXG5cbi8qKlxuICogSW5pdGlhbGl6ZXMgaWRiIGFuZCBjb21wYW5pb24gcHJvY2Vzc2VzIGlmIG5lY2Vzc2FyeSBhbmRcbiAqIGFzc2lnbnMgcGF0aCBwcm9wZXJ0aWVzLiBJdCBpcyBtYW5kYXRvcnkgdG8gY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmVcbiAqIG9uZSBjYW4gc3RhcnQgdXNpbmcgSURCIGluc3RhbmNlLFxuICpcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBtYW5kYXRvcnkgaWRiIGV4ZWN1dGFibGVzIGFyZSBub3QgcHJlc2VudCBvbiB0aGVcbiAqIGxvY2FsaG9zdCBvciB0aGVyZSB3YXMgYSBmYWlsdXJlIHdoaWxlIHN0YXJ0aW5nL2RldGVjdGluZyB0aGVtXG4gKi9cbnN5c3RlbUNhbGxNZXRob2RzLmNvbm5lY3QgPSBhc3luYyBmdW5jdGlvbiBjb25uZWN0IChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIG9ubGluZVRpbWVvdXQsXG4gIH0gPSBvcHRzO1xuXG4gIGNvbnN0IGJpbmFyeVBhdGhzID0ge307XG4gIGZvciAoY29uc3QgYmluYXJ5IG9mIFtJREJfRVhFQ1VUQUJMRSwgSURCX0NPTVBBTklPTl9FWEVDVVRBQkxFXSkge1xuICAgIHRyeSB7XG4gICAgICBiaW5hcnlQYXRoc1tiaW5hcnldID0gYXdhaXQgZnMud2hpY2goYmluYXJ5KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2JpbmFyeX0nIGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBgICtcbiAgICAgICAgYElzIGl0IGluc3RhbGxlZD8gUmVhZCBodHRwczovL3d3dy5mYmlkYi5pbyBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgfVxuICB9XG5cbiAgbG9nLmRlYnVnKGBTdGFydGluZyBhbmQgY29ubmVjdGluZyBjb21wYW5pb246ICcke2JpbmFyeVBhdGhzW0lEQl9DT01QQU5JT05fRVhFQ1VUQUJMRV19J2ApO1xuXG4gIHRyeSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIGlkYiBjb25uZWN0IGNvbW1hbmQgbG9va3MgZm9yIGEgcnVubmluZyBpZGJfY29tcGFuaW9uIHByb2Nlc3MgdGhhdCBhc3NvY2lhdGVzIHdpdGggc3BlY2lmaWVkIHVkaWQuXG4gICAgICAvLyBJZiBub3QgZm91bmQsIHRoZSBjb21tYW5kIGF0dGVtcHRzIHRvIHN0YXJ0IHRoZSBuZXcgaWRiX2NvbXBhbmlvbiBwcm9jZXNzIHRoYXQgbGlzdGVucyBvbiBhbiBVbml4IGRvbWFpbiBzb2NrZXQuXG4gICAgICBhd2FpdCB0cEV4ZWMoSURCX0VYRUNVVEFCTEUsIFsnY29ubmVjdCcsIHRoaXMudWRpZF0pO1xuICAgIH0gY2F0Y2ggKGNvbm5lY3Rpb25FcnJvcikge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyLCAxMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdHBFeGVjKElEQl9FWEVDVVRBQkxFLCBbJ2tpbGwnXSk7XG4gICAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgICAgYXdhaXQgdHBFeGVjKElEQl9FWEVDVVRBQkxFLCBbJ2Nvbm5lY3QnLCB0aGlzLnVkaWRdKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLnN0ZGVyciB8fCBlLnN0ZG91dCkge1xuICAgICAgbG9nLmRlYnVnKGUuc3RkZXJyIHx8IGUuc3Rkb3V0KTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgc3RhcnQgJHtJREJfRVhFQ1VUQUJMRX0gc2VydmljZSBmb3IgdGhlIGRldmljZSAnJHt0aGlzLnVkaWR9Jy4gYCArXG4gICAgICBgQ2hlY2sgdGhlIHNlcnZlciBsb2cgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgfVxuICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIHRoZSBjb25uZWN0aW9uIHRvICR7SURCX0VYRUNVVEFCTEV9IHNlcnZpY2UgZm9yICcke3RoaXMudWRpZH0nYCk7XG5cbiAgaWYgKG9ubGluZVRpbWVvdXQpIHtcbiAgICBhd2FpdCB0aGlzLndhaXRGb3JEZXZpY2Uob25saW5lVGltZW91dCk7XG4gIH1cblxuICB0aGlzLmV4ZWN1dGFibGUucGF0aCA9IGJpbmFyeVBhdGhzW0lEQl9FWEVDVVRBQkxFXTtcbiAgdGhpcy5jb21wYW5pb24ucGF0aCA9IGJpbmFyeVBhdGhzW0lEQl9DT01QQU5JT05fRVhFQ1VUQUJMRV07XG59O1xuXG4vKipcbiAqIEJsb2NrcyB1bnRpbCB0aGUgZGV2aWNlIHVuZGVyIHRlc3Qgc3RhcnRzIHJlc3BvbmRpbmcgdG8gaWRiIGNvbW1hbmRzLlxuICogVGhlIGRldmljZSBtdXN0IGJlIGJvb3RlZC9vbmxpbmUgYW5kIGlkYiBtdXN0IGJlIGFscmVhZHkgY29ubmVjdGVkIGZvciB0aGF0IHRvIGhhcHBlblxuICpcbiAqIEBwYXJhbSB7P251bWJlcn0gdGltZW91dE1zIFsxMDAwMF0gLSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0XG4gKiB1bnRpbCB0aGUgZGV2aWNlIHVuZGVyIHRlc3RzIGlzIG9ubGluZS4gVGhlIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseVxuICogaWYgdGhlIHRpbWVvdXQgaXMgZmFsc3lcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgZGV2aWNlIGlzIG5vdCByZXNwb25kaW5nIHdpdGhpbiB0aGUgZ2l2ZW4gdGltZW91dFxuICovXG5zeXN0ZW1DYWxsTWV0aG9kcy53YWl0Rm9yRGV2aWNlID0gYXN5bmMgZnVuY3Rpb24gd2FpdEZvckRldmljZSAodGltZW91dE1zID0gMTAwMDApIHtcbiAgaWYgKCF0aW1lb3V0TXMpIHtcbiAgICBsb2cuZGVidWcoJ05vIHRpbWVvdXQgaXMgcHJvdmlkZWQsIHNvIG5vdCB3YWl0aW5nIHVudGlsIHRoZSBkZXZpY2UgaXMgb25saW5lJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBXYWl0aW5nIHVwIHRvICR7dGltZW91dE1zfW1zIGZvciB0aGUgZGV2aWNlIHRvIGJlIG9ubGluZWApO1xuICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICBsZXQgbGFzdEVycm9yID0gbnVsbDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlYyhbJ3VpJywgJ2Rlc2NyaWJlLWFsbCddKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxhc3RFcnJvciA9IGUuc3RkZXJyIHx8IGUubWVzc2FnZTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0sIHtcbiAgICAgIHdhaXRNczogdGltZW91dE1zLFxuICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZGV2aWNlICcke3RoaXMudWRpZH0nIGlzIG5vdCByZXNwb25kaW5nIHRvIGlkYiByZXF1ZXN0cyBhZnRlciAke3RpbWVvdXRNc31tcyB0aW1lb3V0LiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtsYXN0RXJyb3IgfHwgZS5tZXNzYWdlfWApO1xuICB9XG4gIGxvZy5kZWJ1ZyhgVGhlIGRldmljZSAnJHt0aGlzLnVkaWR9JyBpcyBvbmxpbmUgYW5kIHJlYWR5IHRvIGFjY2VwdCBpZGIgY29tbWFuZHMgaW4gYCArXG4gICAgYCR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc1NlY29uZHMudG9GaXhlZCgzKX1zYCk7XG59O1xuXG4vKipcbiAqIFBlcmZvcm1zIGNsZWFudXAgb2Ygb2Jzb2xldGUgY29tcGFuaW9uIHByb2Nlc3Nlc1xuICogVGhlIGRhZW1vbiBwcm9jZXNzIGlzIGxlZnQgdW50b3VjaGVkLCBiZWNhdXNlIGtpbGxpbmcgaXQgbWlnaHRcbiAqIHBvdGVudGlhbGx5IGFmZmVjdCBvdGhlciBwYXJhbGxlbCBzZXNzaW9ucy4gTm90aGluZ1xuICogaXMgZG9uZSBpZiBubyBvYnNvbGV0ZSBwcm9jZXNzZXMgYXJlIGZvdW5kLlxuICovXG5zeXN0ZW1DYWxsTWV0aG9kcy5kaXNjb25uZWN0ID0gYXN5bmMgZnVuY3Rpb24gZGlzY29ubmVjdCAoKSB7XG4gIGxvZy5kZWJ1ZyhgRGlzY29ubmVjdGluZyAke0lEQl9FWEVDVVRBQkxFfSBzZXJ2aWNlIGZyb20gJyR7dGhpcy51ZGlkfSdgKTtcblxuICB0cnkge1xuICAgIC8vIGlkYiBkaXNjb25uZWN0IGp1c3QgcmVtb3ZlcyB0aGUgZ2l2ZW4gdWRpZCBmcm9tIGlkYiBzdGF0ZS5cbiAgICAvLyBJdCBkb2Vzbid0IGtpbGwgdGhlIGlkYl9jb21wYW5pb24gcHJvY2VzcyBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQuXG4gICAgYXdhaXQgdHBFeGVjKHRoaXMuZXhlY3V0YWJsZS5wYXRoLCBbJ2Rpc2Nvbm5lY3QnLCB0aGlzLnVkaWRdKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuXG4gIGNvbnN0IGNvbXBhbmlvblBpZHMgPSBhd2FpdCBnZXRQaWRzKENPTVBBTklPTl9QR1JFUF9QQVRURVJOKHRoaXMudWRpZCkpO1xuICBpZiAoXy5pc0VtcHR5KGNvbXBhbmlvblBpZHMpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBDbGVhbmluZyB1cCAke2NvbXBhbmlvblBpZHMubGVuZ3RofSBvYnNvbGV0ZSAke0lEQl9DT01QQU5JT05fRVhFQ1VUQUJMRX0gYCArXG4gICAgYHByb2Nlc3Mke2NvbXBhbmlvblBpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfWApO1xuICBhd2FpdCB0cEV4ZWMoJ2tpbGwnLCBbJy0yJywgLi4uY29tcGFuaW9uUGlkc10pO1xufTtcblxuLyoqXG4gKiBFeGVjdXRlIHRoZSBnaXZlbiBpZGIgY29tbWFuZC5cbiAqXG4gKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSBjbWQgLSBUaGUgYWN0dWFsIGlkYiBjb21tYW5kIHdpdGhvdXQgYXJndW1lbnRzL3BhcmFtcy5cbiAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gYXJncyAtIE9wdGlvbmFsIGNvbW1hbmQgYXJndW1lbnRzLlxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMgLSBBZGRpdGlvbmFsIG9wdGlvbnMgbWFwcGluZy4gU2VlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL25vZGUtdGVlbl9wcm9jZXNzfVxuICogICAgICAgICAgICAgICAgICAgICAgICBmb3IgbW9yZSBkZXRhaWxzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQncyBzdGRvdXQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGNvbW1hbmQgcmV0dXJuZWQgbm9uLXplcm8gZXhpdCBjb2RlLlxuICovXG5zeXN0ZW1DYWxsTWV0aG9kcy5leGVjID0gYXN5bmMgZnVuY3Rpb24gZXhlYyAoY21kLCBhcmdzID0gW10sIG9wdHMgPSB7fSkge1xuICBpZiAoIWNtZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignWW91IG5lZWQgdG8gcGFzcyBpbiBhIGNvbW1hbmQgdG8gZXhlYygpJyk7XG4gIH1cbiAgY21kID0gXy5pc0FycmF5KGNtZCkgPyBjbWQgOiBbY21kXTtcblxuICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gIC8vIHNldHRpbmcgZGVmYXVsdCB0aW1lb3V0IGZvciBlYWNoIGNvbW1hbmQgdG8gcHJldmVudCBpbmZpbml0ZSB3YWl0LlxuICBvcHRzLnRpbWVvdXQgPSBvcHRzLnRpbWVvdXQgfHwgdGhpcy5leGVjVGltZW91dCB8fCBERUZBVUxUX0lEQl9FWEVDX1RJTUVPVVQ7XG4gIG9wdHMudGltZW91dENhcE5hbWUgPSBvcHRzLnRpbWVvdXRDYXBOYW1lIHx8ICdleGVjVGltZW91dCc7IC8vIEZvciBlcnJvciBtZXNzYWdlXG5cbiAgY29uc3QgZnVsbEFyZ3MgPSBbLi4uY21kLCAuLi50aGlzLmV4ZWN1dGFibGUuZGVmYXVsdEFyZ3MsIC4uLmFyZ3NdO1xuICBsb2cuZGVidWcoYFJ1bm5pbmcgJyR7dGhpcy5leGVjdXRhYmxlLnBhdGh9ICR7dXRpbC5xdW90ZShmdWxsQXJncyl9J2ApO1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgdHBFeGVjKHRoaXMuZXhlY3V0YWJsZS5wYXRoLCBmdWxsQXJncywgb3B0cyk7XG4gICAgcmV0dXJuIHN0ZG91dDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGUuY29kZSkpIHtcbiAgICAgIGUubWVzc2FnZSA9IGBFcnJvciBleGVjdXRpbmcgJHtJREJfRVhFQ1VUQUJMRX0uIE9yaWdpbmFsIGVycm9yOiAnJHtlLm1lc3NhZ2V9JzsgYCArXG4gICAgICAgIGBTdGRvdXQ6ICckeyhlLnN0ZG91dCB8fCAnJykudHJpbSgpfSc7IGAgK1xuICAgICAgICBgU3RkZXJyOiAnJHsoZS5zdGRlcnIgfHwgJycpLnRyaW0oKX0nOyBgICtcbiAgICAgICAgYENvZGU6ICcke2UuY29kZX0nYDtcbiAgICB9IGVsc2Uge1xuICAgICAgZS5tZXNzYWdlID0gYEVycm9yIGV4ZWN1dGluZyAke0lEQl9FWEVDVVRBQkxFfS4gT3JpZ2luYWwgZXJyb3I6ICcke2UubWVzc2FnZX0nLiBgICtcbiAgICAgICAgYFRyeSB0byBpbmNyZWFzZSB0aGUgJHtvcHRzLnRpbWVvdXR9bXMgJHtJREJfRVhFQ1VUQUJMRX0gZXhlY3V0aW9uIHRpbWVvdXQgcmVwcmVzZW50ZWQgYnkgJyR7b3B0cy50aW1lb3V0Q2FwTmFtZX0nIGNhcGFiaWxpdHlgO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9XG59O1xuXG4vKipcbiAqIENyZWF0ZXMgU3ViUHJvY2VzcyBpbnN0YW5jZSBvZiBpZGIgZm9yIGJhY2tncm91bmRcbiAqIGV4ZWN1dGlvbi5cbiAqXG4gKiBAcGFyYW0ge0FycmF5PFN0cmluZz59IGNvbW1hbmQgZGVzaXJlZCBpZGIgY29tbWFuZCAoZS5nLjogW1wibGF1bmNoXCJdLCBbXCJ4Y3Rlc3RcIiwgXCJydW5cIiwgXCJ1aVwiXSlcbiAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nPn0gYXJncyBhZGRpdGlvbmFsIGlkYiBhcmd1bWVudHNcbiAqIEByZXR1cm5zIHtTdWJQcm9jZXNzfVxuICovXG5zeXN0ZW1DYWxsTWV0aG9kcy5jcmVhdGVTdWJQcm9jZXNzID0gZnVuY3Rpb24gY3JlYXRlU3ViUHJvY2VzcyAoY29tbWFuZCA9IFtdLCBhcmdzID0gW10sIG9wdHMgPSB7fSkge1xuICBjb25zdCBpZGJBcmdzID0gWy4uLmNvbW1hbmQsIC4uLnRoaXMuZXhlY3V0YWJsZS5kZWZhdWx0QXJncywgLi4uYXJnc107XG4gIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgJHtJREJfRVhFQ1VUQUJMRX0gc3VicHJvY2VzcyB3aXRoIGFyZ3M6ICR7dXRpbC5xdW90ZShhcmdzKX1gKTtcbiAgcmV0dXJuIG5ldyBTdWJQcm9jZXNzKHRoaXMuZXhlY3V0YWJsZS5wYXRoLCBpZGJBcmdzLCBvcHRzKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHN5c3RlbUNhbGxNZXRob2RzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLFFBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLGFBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUgsT0FBQTtBQUNBLElBQUFJLFNBQUEsR0FBQUosT0FBQTtBQUNBLElBQUFLLFFBQUEsR0FBQUwsT0FBQTtBQUlBLElBQUFNLE9BQUEsR0FBQUgsc0JBQUEsQ0FBQUgsT0FBQTtBQUdBLE1BQU1PLHVCQUF1QixHQUFJQyxJQUFJLElBQ2xDLEdBQUVDLGlDQUF5Qix1QkFBc0JELElBQUssRUFBQztBQUUxRCxNQUFNRSxpQkFBaUIsR0FBRyxDQUFDLENBQUM7QUFvQjVCQSxpQkFBaUIs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